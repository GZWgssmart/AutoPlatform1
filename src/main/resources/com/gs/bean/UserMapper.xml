<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.gs.dao.UserDAO">
  <resultMap id="userBasicManageMap" type="com.gs.bean.User">
    <id column="userId" jdbcType="VARCHAR" property="userId" />
    <result column="userEmail" jdbcType="VARCHAR" property="userEmail" />
    <result column="userPhone" jdbcType="VARCHAR" property="userPhone" />
    <result column="userPwd" jdbcType="VARCHAR" property="userPwd" />
    <result column="userNickname" jdbcType="VARCHAR" property="userNickname" />
    <result column="userIdentity" jdbcType="VARCHAR" property="userIdentity" />
    <result column="userName" jdbcType="VARCHAR" property="userName" />
    <result column="userGender" jdbcType="VARCHAR" property="userGender" />
    <result column="userBirthday" jdbcType="TIMESTAMP" property="userBirthday" />
    <result column="userAddress" jdbcType="VARCHAR" property="userAddress" />
    <result column="qqOpenId" jdbcType="VARCHAR" property="qqOpenId" />
    <result column="weiboOpenId" jdbcType="VARCHAR" property="weiboOpenId" />
    <result column="weChatOpenId" jdbcType="VARCHAR" property="weChatOpenId" />
    <result column="userIcon" jdbcType="VARCHAR" property="userIcon" />
    <result column="userDes" jdbcType="VARCHAR" property="userDes" />
    <result column="companyId" jdbcType="VARCHAR" property="companyId" />
    <result column="userSalary" jdbcType="DOUBLE" property="userSalary" />
    <result column="userCreatedTime" jdbcType="TIMESTAMP" property="userCreatedTime" />
    <result column="userLoginedTime" jdbcType="TIMESTAMP" property="userLoginedTime" />
    <result column="userStatus" jdbcType="VARCHAR" property="userStatus" />

    <association property="company" javaType="com.gs.bean.Company">
      <id property="companyId" column="companyId"></id>
      <result property="companyName" column="companyName"></result>
      <result property="companyDes" column="compangyDes"></result>
    </association>
    
    <association property="role" javaType="com.gs.bean.Role">
      <id property="roleId" column="roleId"></id>
      <result property="roleName" column="roleName"></result>
      <result property="roleDes" column="roleDes"></result>
      <result property="roleStatus" column="roleStatus"></result>
    </association>

  </resultMap>

  <!-- 添加员工的基本信息 -->
  <insert id="insert" parameterType="user">
    <![CDATA[
        insert into t_user(userId, userEmail, userPhone, userPwd, userIdentity, userName,
              userGender,userBirthday, userAddress, qqOpenId, weChatOpenId, weiboOpenId,
              userIcon, userDes, companyId, userSalary, userCreatedTime, userStatus)
            values(uuid(), #{userEmail}, #{userPhone}, #{userPwd}, #{userIdentity},
              #{userName}, #{userGender},#{userBirthday}, #{userAddress}, #{qqOpenId},
              #{weChatOpenId}, #{weiboOpenId}, #{userIcon}, #{userDes}, #{companyId},
              #{userSalary}, now(), 'Y');
      ]]>
  </insert>

  <!-- 修改员工的基本信息 -->
  <update id="update" parameterType="user">
     <![CDATA[
       update t_user u set u.userName = #{userName}, u.userEmail = #{userEmail}, u.userPhone = #{userPhone},
            u.userIdentity = #{userIdentity}, u.userGender = #{userGender},u.userNickname=#{userNickname},
           u.userBirthDay = #{userBirthday}, u.userDes = #{userDes}, u.userSalary = #{userSalary},
           u.userLoginedTime = #{userLoginedTime}, u.userAddress = #{userAddress}
        where u.userId = #{userId};
     ]]>
  </update>

  <!-- 修改密码 -->
  <update id="updatePwd" parameterType="user">
    <![CDATA[
       update t_user u set u.userPwd = #{userPwd} where u.userId = #{userId};
     ]]>
  </update>

  <!-- 禁用 -->
  <update id="inactive" parameterType="user">
    <![CDATA[
      update t_user u set u.userStatus = 'N' where u.userId = #{userId};
    ]]>
  </update>

  <!-- 激活 -->
  <update id="active" parameterType="user">
    <![CDATA[
      update t_user u set u.userStatus = 'Y' where u.userId = #{userId};
    ]]>
  </update>

  <!-- 分页查询全部 -->
  <select id="queryByPagerAll" resultMap="userBasicManageMap" parameterType="com.gs.common.bean.Pager">
    <![CDATA[
      select u.*, r.*, c.companyId, c.companyName from t_user u
          left join t_user_role ur on u.userId = ur.userId
          left join t_role r on r.roleId = ur.roleId
          left join t_company c on u.companyId = c.companyId
        where 1 = 1
    ]]>
    <if test="user.companyId != null and user.companyId != ''">
        and u.companyId = #{user.companyId}
        and ur.roleId !='7ff4f1c5-3205-11e7-bc72-507b9d765567'
        and ur.roleId != '80095901-3205-11e7-bc72-507b9d765567'
    </if>
     limit #{beginIndex}, #{pageSize};
  </select>

  <!-- 分页查询状态为可用的记录 -->
  <select id="queryByPager" resultMap="userBasicManageMap" parameterType="com.gs.common.bean.Pager">
    <![CDATA[
      select u.*, r.*, c.companyId, c.companyName from t_user u
        left join t_user_role ur on u.userId = ur.userId
        left join t_role r on r.roleId = ur.roleId
        left join t_company c on u.companyId = c.companyId
        where u.userStatus = 'Y'
    ]]>
    <if test="user.companyId != null and user.companyId != ''">
      and u.companyId = #{user.companyId}
      and ur.roleId !='7ff4f1c5-3205-11e7-bc72-507b9d765567'
      and ur.roleId != '80095901-3205-11e7-bc72-507b9d765567'
    </if>
     limit #{beginIndex}, #{pageSize};
  </select>

  <!-- 分页查询状态为不可用的员工及角色名称 -->
  <select id="queryByPagerDisable" resultMap="userBasicManageMap" parameterType="com.gs.common.bean.Pager">
    <![CDATA[
      select u.*, r.*, c.companyId, c.companyName from t_user u
        left join t_user_role ur on u.userId = ur.userId
        left join t_role r on r.roleId = ur.roleId
        left join t_company c on u.companyId = c.companyId
        where u.userStatus = 'N'
    ]]>
    <if test="user.companyId != null and user.companyId != ''">
      and u.companyId = #{user.companyId}
      and ur.roleId !='7ff4f1c5-3205-11e7-bc72-507b9d765567'
      and ur.roleId != '80095901-3205-11e7-bc72-507b9d765567'
    </if>
    limit #{beginIndex}, #{pageSize};
  </select>

  <select id="count" resultType="int" parameterType="user">
    <![CDATA[
      select count(*) from t_user u where u.userStatus = 'Y'
    ]]>
    <if test="companyId != null and companyId != ''">
      and u.companyId = #{companyId}
    </if>
  </select>

  <!-- 下拉列表 -->
  <select id="queryAll" resultMap="userBasicManageMap" parameterType="com.gs.bean.User">
    <![CDATA[
      select * from t_user u where 1 = 1 and u.userStatus = 'Y'
    ]]>
    <if test="companyId != null and companyId != ''">
      and u.companyId = #{user.companyId}
    </if>
  </select>

  <!-- 根据id查询员工的基本信息 -->
  <select id="queryById" resultMap="userBasicManageMap" parameterType="String">
    <![CDATA[
      select u.*, r.*, c.companyId, c.companyName from t_user u
          left join t_user_role ur on u.userId = ur.userId
          left join t_role r on r.roleId = ur.roleId
          left join t_company c on u.companyId = c.companyId
       where u.userId = #{userId}
    ]]>
    <if test="user.companyId != null and user.companyId != ''">
      and u.companyId = #{user.companyId}
    </if>
   </select>

  <!-- 根据id查询员工的基本信息 -->
  <select id="queryInfoById" resultMap="userBasicManageMap" parameterType="String">
    <![CDATA[
      select u.* from t_user u where u.userId = #{userId}
    ]]>
  </select>

  <select id="queryRoles" parameterType="String" resultType="String">
    SELECT roleName FROM auto_platform.t_role WHERE roleStatus = 'Y' and roleId
    IN (select t_user_role.roleId from auto_platform.t_user_role
    WHERE userId = (select t_user.userId from auto_platform.t_user where userEmail = #{email} OR userPhone=#{email}))
  </select>

  <select id="queryPermissions" parameterType="String" resultType="String">
    SELECT permissionName FROM auto_platform.t_permission
    WHERE permissionStatus = 'Y' and permissionId IN (SELECT t_role_permission.permissionId FROM auto_platform.t_role_permission
    WHERE roleId IN (SELECT t_user_role.roleId FROM auto_platform.t_user_role
    WHERE userId = (SELECT t_user.userId FROM auto_platform.t_user
    WHERE userEmail = #{email} OR userPhone=#{email})))
  </select>

  <!-- 根据维修保养记录查询到用户的email发送邮件提醒车主进行提车 -->
  <select id="queryEmail" resultMap="userBasicManageMap">
    <![CDATA[
      select u.* from t_user u where userId in (
      select userId from t_checkin where checkinId in (
      select ck.checkinId from t_maintain_record m, t_checkin ck
      where m.checkinId = ck.checkinId and m.recordId in (${ids})));
    ]]>
  </select>

  <select id="queryByEmail" resultMap="userBasicManageMap">
    <![CDATA[
          SELECT *FROM auto_platform.t_user WHERE userStatus = 'Y' and userEmail=#{email} OR userPhone=#{email}
        ]]>
  </select>

  <!-- 根据角色名称查询人员基本信息 -->
  <select id="queryByRoleName" resultMap="userBasicManageMap">
    <![CDATA[
      SELECT u.* FROM t_user u, t_user_role ur, t_role r
	    WHERE u.userId = ur.userId AND ur.roleId = r.roleId AND r.roleName IN (#{roleName})
    ]]>
  </select>

  <!--根据用户输入的邮箱或者手机号判断成功时, 查询到此用户所有信息-->
  <select id ="queryUser" resultType="user">
    <![CDATA[
      select * from t_user where userPhone= #{eamil} or userEmail = #{eamil}
    ]]>
  </select>

  <!-- 测试用，不要删  -->
  <select id ="queryByPhone" resultMap="userBasicManageMap">
    <![CDATA[
      select  u.*, r.*, c.companyId, c.companyName from t_user u
          left join t_user_role ur on u.userId = ur.userId
          left join t_role r on r.roleId = ur.roleId
          left join t_company c on u.companyId = c.companyId
       where userPhone= #{userPhone}
    ]]>
  </select>
  <!-- 同上 -->
  <update id="updIcon" >
    <![CDATA[
      update  t_user set userIcon=#{userIcon} where userId = #{userId}
    ]]>
  </update>

</mapper>