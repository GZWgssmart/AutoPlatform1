<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.gs.dao.AccessoriesBuyDAO">
    <resultMap id="AccessoriesBuyMap" type="com.gs.bean.AccessoriesBuy">
        <id column="accBuyId" property="accBuyId"/>
        <result column="accId" property="accId"/>
        <result column="accUnit" property="accUnit"/>
        <result column="accBuyCount" property="accBuyCount"/>
        <result column="accBuyPrice" property="accBuyPrice"/>
        <result column="accBuyTotal" property="accBuyTotal"/>
        <result column="accBuyDiscount" property="accBuyDiscount"/>
        <result column="accBuyMoney" property="accBuyMoney"/>
        <result column="accBuyTime" property="accBuyTime"/>
        <result column="accBuyCreatedTime" property="accBuyCreatedTime"/>
        <result column="companyId" property="companyId"/>
        <result column="accBuyStatus" property="accBuyStatus"/>

        <result column="count" property="count"/>
        <result column="week" property="week"/>

        <association property="company" javaType="com.gs.bean.Company">
            <id property="companyId" column="companyId"/>
            <id property="companyName" column="companyName"/>
        </association>

        <association property="accessories" javaType="com.gs.bean.Accessories">
            <id property="accId" column="accId"/>
            <id property="accName" column="accName"/>
        </association>

    </resultMap>

    <!--
        查询所有的采购记录
    -->
    <select id="queryAll" resultMap="AccessoriesBuyMap">
        <![CDATA[
            select * from auto_platform.t_accessories_buy
        ]]>
    </select>

    <!-- 分页查询 -->
    <select id="queryByPager" resultMap="AccessoriesBuyMap" parameterType="com.gs.common.bean.Pager">
        <![CDATA[
          select ab.*,cp.companyId,cp.companyName,ac.accId,ac.accName
           from auto_platform.t_accessories_buy ab
           LEFT JOIN auto_platform.t_accessories ac on ab.accId=ac.accId
           LEFT JOIN auto_platform.t_company cp on ab.companyId=cp.companyId
           where ab.accBuyStatus = 'Y' order by ab.accBuyCreatedTime Desc
        ]]>
        limit #{beginIndex}, #{pageSize};
    </select>

    <!-- 查询有多少配件销售采购信息 -->
    <select id="count" resultType="int" >
        <![CDATA[
      select count(*) from auto_platform.t_accessories_buy u where 1 =1 and u.accBuyStatus = 'Y'
    ]]>
    </select>

    <!--
        添加采购记录
    -->
    <insert id="insert" useGeneratedKeys="true" keyProperty="id" parameterType="AccessoriesBuy">
        <![CDATA[
            INSERT INTO auto_platform.t_accessories_buy
            (accBuyId,accId, accBuyCount, accBuyPrice, accBuyTotal,accBuyDiscount, accBuyMoney, accBuyTime, accBuyCreatedTime,companyId, accBuyStatus)
            VALUES
            (uuid(),#{accId},abs(#{accBuyCount}),abs(#{accBuyPrice}),abs(#{accBuyTotal}),abs(#{accBuyDiscount}),abs(#{accBuyMoney}),#{accBuyTime},CURRENT_TIMESTAMP ,#{companyId},'Y')
        ]]>
    </insert>

    <!--
        更新采购记录信息
    -->
    <update id="update" keyProperty="id" parameterType="java.util.Map">
        <![CDATA[
        UPDATE auto_platform.t_accessories_buy
        SET accBuyCount=abs(#{accBuyCount}), accBuyPrice=abs(#{accBuyPrice}),
        accBuyTotal=abs(#{accBuyTotal}),accBuyDiscount=abs(#{accBuyDiscount}),
        accBuyMoney=abs(#{accBuyMoney}),accBuyTime=#{accBuyTime},
        companyId=#{companyId},accId=#{accId}
        WHERE accBuyId=#{accBuyId}
        ]]>
    </update>

    <!--
        根据id删除对应的配件采购记录
    -->
    <delete id="deleteById">
        <![CDATA[
        DELETE FROM auto_platform.t_accessories_buy WHERE accBuyId=#{accBuyId}
        ]]>
    </delete>


    <!--
        冻结配件采购信息
    -->
    <update id="inactive" keyProperty="id" parameterType="string">
        <![CDATA[
        update auto_platform.t_accessories_buy set accBuyStatus = 'N' where accBuyId = #{accBuyId}
        ]]>
    </update>

    <!--
        激活配件采购信息
    -->
    <update id="active" keyProperty="id" parameterType="string">
        <![CDATA[
        update auto_platform.t_accessories_buy set accBuyStatus = 'Y' where accBuyId = #{accBuyId}
        ]]>
    </update>

    <select id="queryAllStatus" parameterType="string" resultMap="AccessoriesBuyMap">
        <![CDATA[
        select * from auto_platform.t_accessories_buy WHERE accBuyStatus=#{accBuyStatus};
        ]]>
    </select>

    <select id="queryByPagerDisable" resultMap="AccessoriesBuyMap" parameterType="com.gs.common.bean.Pager">
        <![CDATA[
       SELECT abu.*,cp.companyId,cp.companyName,ac.accId,ac.accName FROM auto_platform.t_accessories_buy abu
       LEFT JOIN auto_platform.t_company cp on cp.companyId=abu.companyId
       LEFT JOIN auto_platform.t_accessories ac on ac.accId=abu.accId
       WHERE accBuyStatus='N'
       ]]>
        limit #{beginIndex}, #{pageSize}
    </select>

    <select id="countByDisable" resultType="int" >
        <![CDATA[
      select count(accBuyId) from auto_platform.t_accessories_buy ck where ck.accBuyStatus = 'N'
    ]]>
    </select>

    <!-- 分页模糊查询 -->
    <select id="blurredQuery" resultMap="AccessoriesBuyMap" >
        <![CDATA[
           select abu.*,cp.companyId,cp.companyName,ac.accId,ac.accName from auto_platform.t_accessories_buy abu
           LEFT JOIN auto_platform.t_company cp on abu.companyId=cp.companyId
           LEFT JOIN auto_platform.t_accessories ac on abu.accId=ac.accId
           where 1=1 AND
        ]]>
        <if test="accBuy.companyId != '' and accBuy.companyId != null">
            cp.companyName like '%${accBuy.companyId}%'
        </if>
        <if test="accBuy.companyId != '' and accBuy.companyId != null and
            accBuy.accId != '' and accBuy.accId != null">
            OR
        </if>
        <if test="accBuy.accId!='' and accBuy.accId!= null">
            ac.accName LIKE '%${accBuy.accId}%'
        </if>
        ORDER by abu.accBuyCreatedTime DESC
        limit #{pager.beginIndex}, #{pager.pageSize}
    </select>

    <!-- 分页模糊查询个数 -->
    <select id="countByBlurred" resultType="int" >
        <![CDATA[
           select count(accBuyId) from auto_platform.t_accessories_buy abu
           LEFT JOIN auto_platform.t_company cp on abu.companyId=cp.companyId
           LEFT JOIN auto_platform.t_accessories ac on abu.accId=ac.accId
           where 1=1 AND
        ]]>
        <if test="accBuy.companyId != '' and accBuy.companyId != null">
            cp.companyName like '%${accBuy.companyId}%'
        </if>
        <if test="accBuy.companyId != '' and accBuy.companyId != null and
            accBuy.accId != '' and accBuy.accId != null">
            OR
        </if>
        <if test="accBuy.accId!='' and accBuy.accId!= null">
            ac.accName LIKE '%${accBuy.accId}%'
        </if>
    </select>

    <!--下单报表统计-->

    <select id="queryByCondition" resultMap="AccessoriesBuyMap">
        <![CDATA[
            select count(*) as count ,week(ab.accBuyCreatedTime) as week, ab.accBuyCreatedTime from t_accessories_buy ab, t_company cc where ab.companyId = cc.companyId and ab.companyId = #{companyId}
and ab.accBuyStatus = 'Y' and ab.accBuyCreatedTime >= #{start} and ab.accBuyCreatedTime <= #{end}
        ]]>
        <if test="type =='year'">
            group by date_format(ab.accBuyCreatedTime, '%Y') ORDER BY ab.accBuyCreatedTime ASC;
        </if>
        <if test="type =='quarter'">
            group by concat(date_format(ab.accBuyCreatedTime, '%Y'),FLOOR((date_format(ab.accBuyCreatedTime, '%m')+2)/3)) ORDER BY ab.accBuyCreatedTime ASC;
        </if>
        <if test="type =='month'">
            group by date_format(ab.accBuyCreatedTime, '%y-%m') ORDER BY ab.accBuyCreatedTime ASC;
        </if>
        <if test="type =='week'">
            group by date_format(ab.accBuyCreatedTime, '%y-%m') ORDER BY ab.accBuyCreatedTime ASC;
        </if>
        <if test="type =='day'">
            group by date(ab.accBuyCreatedTime) ORDER BY ab.accBuyCreatedTime ASC;
        </if>
    </select>



    <!--支付记录报表-->
    <select id="queryByPayCondition" resultMap="AccessoriesBuyMap">
        <![CDATA[
       select sum(accBuyMoney) as accBuyMoney ,ab.accBuyCreatedTime from t_accessories_buy ab, t_company cc where ab.companyId = cc.companyId and ab.companyId = #{companyId}
and ab.accBuyStatus = 'Y' and ab.accBuyCreatedTime >= #{start} and ab.accBuyCreatedTime <= #{end}
        ]]>
        <if test="type =='year'">
            GROUP BY year(ab.accBuyCreatedTime);
        </if>
        <if test="type =='quarter'">
            GROUP BY quarter(ab.accBuyCreatedTime);
        </if>
        <if test="type =='month'">
            GROUP BY month(ab.accBuyCreatedTime);
        </if>
        <if test="type =='week'">
            GROUP BY week(ab.accBuyCreatedTime);
        </if>
        <if test="type =='day'">
            GROUP BY day(ab.accBuyCreatedTime);
        </if>
    </select>

</mapper>